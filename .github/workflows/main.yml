name: æ™ºèƒ½å¢é‡åŒæ­¥åˆ°ä¸ƒç‰›äº‘

on:
  push:
    branches:
      - main
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  smart_deploy_to_qiniu:
    name: æ™ºèƒ½å¢é‡åŒæ­¥åˆ°ä¸ƒç‰›äº‘
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿æ¯”è¾ƒå·®å¼‚
        
      - name: åˆ†ææ–‡ä»¶å˜æ›´
        id: changed-files
        run: |
          echo "ğŸ” æ­£åœ¨åˆ†ææ–‡ä»¶å˜æ›´..."
          
          # åˆå§‹åŒ–å˜é‡
          ADDED_FILES=""
          MODIFIED_FILES=""
          DELETED_FILES=""
          
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          if [ "${{ github.event_name }}" = "push" ]; then
            # å¯¹äº push äº‹ä»¶ï¼Œæ¯”è¾ƒå½“å‰æäº¤ä¸å‰ä¸€ä¸ªæäº¤
            if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              echo "ğŸ“‹ æ¯”è¾ƒæäº¤: ${{ github.event.before }} -> ${{ github.sha }}"
              
              # æ£€æŸ¥ä¹‹å‰çš„æäº¤æ˜¯å¦å­˜åœ¨
              if git cat-file -e ${{ github.event.before }} 2>/dev/null; then
                echo "âœ… æ‰¾åˆ°ä¹‹å‰çš„æäº¤ï¼Œè¿›è¡Œå·®å¼‚æ¯”è¾ƒ"
                ADDED_FILES=$(git diff --name-only --diff-filter=A ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || true)
                MODIFIED_FILES=$(git diff --name-only --diff-filter=M ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || true)
                DELETED_FILES=$(git diff --name-only --diff-filter=D ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || true)
              else
                echo "âš ï¸ æ— æ³•æ‰¾åˆ°ä¹‹å‰çš„æäº¤ï¼Œå›é€€åˆ° HEAD~1 æ¯”è¾ƒ"
                if git rev-parse HEAD~1 >/dev/null 2>&1; then
                  ADDED_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD 2>/dev/null || true)
                  MODIFIED_FILES=$(git diff --name-only --diff-filter=M HEAD~1 HEAD 2>/dev/null || true)
                  DELETED_FILES=$(git diff --name-only --diff-filter=D HEAD~1 HEAD 2>/dev/null || true)
                else
                  echo "âš ï¸ è¿™ä¼¼ä¹æ˜¯é¦–æ¬¡æäº¤ï¼Œåˆ—å‡ºæ‰€æœ‰æ–‡ä»¶"
                  ADDED_FILES=$(git ls-tree -r --name-only HEAD 2>/dev/null || true)
                  MODIFIED_FILES=""
                  DELETED_FILES=""
                fi
              fi
            else
              # é¦–æ¬¡æ¨é€ï¼Œåˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
              echo "ğŸ“‹ é¦–æ¬¡æ¨é€ï¼Œè·å–æ‰€æœ‰æ–‡ä»¶"
              ADDED_FILES=$(git ls-tree -r --name-only HEAD 2>/dev/null || true)
              MODIFIED_FILES=""
              DELETED_FILES=""
            fi
          else
            # æ‰‹åŠ¨è§¦å‘ï¼Œæ˜¾ç¤ºæœ€è¿‘ä¸€æ¬¡æäº¤çš„å˜æ›´
            echo "ğŸ“‹ æ‰‹åŠ¨è§¦å‘ï¼Œåˆ†ææœ€è¿‘ä¸€æ¬¡æäº¤çš„å˜æ›´"
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              ADDED_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD 2>/dev/null || true)
              MODIFIED_FILES=$(git diff --name-only --diff-filter=M HEAD~1 HEAD 2>/dev/null || true)
              DELETED_FILES=$(git diff --name-only --diff-filter=D HEAD~1 HEAD 2>/dev/null || true)
            else
              echo "âš ï¸ åªæœ‰ä¸€ä¸ªæäº¤ï¼Œåˆ—å‡ºæ‰€æœ‰æ–‡ä»¶"
              ADDED_FILES=$(git ls-tree -r --name-only HEAD 2>/dev/null || true)
              MODIFIED_FILES=""
              DELETED_FILES=""
            fi
          fi
          
          # è¿‡æ»¤æ‰ä¸éœ€è¦åŒæ­¥çš„æ–‡ä»¶ï¼ˆå¦‚.gitç›¸å…³æ–‡ä»¶ï¼‰
          filter_files() {
            echo "$1" | grep -v "^\.git" | grep -v "^\.github/" | grep -v "README\.md$" | grep -v "\.gitignore$" || true
          }
          
          echo "ğŸ” è¿‡æ»¤ä¸éœ€è¦åŒæ­¥çš„æ–‡ä»¶..."
          ADDED_FILES_FILTERED=$(filter_files "$ADDED_FILES")
          MODIFIED_FILES_FILTERED=$(filter_files "$MODIFIED_FILES")
          DELETED_FILES_FILTERED=$(filter_files "$DELETED_FILES")
          
          # æ˜¾ç¤ºè¯¦ç»†çš„å˜æ›´ä¿¡æ¯
          echo ""
          echo "ğŸ“Š æ–‡ä»¶å˜æ›´åˆ†æè¯¦æƒ…ï¼š"
          
          # ç»Ÿè®¡æ–°å¢æ–‡ä»¶
          if [ -n "$ADDED_FILES_FILTERED" ] && [ "$ADDED_FILES_FILTERED" != "" ]; then
            ADDED_COUNT=$(echo "$ADDED_FILES_FILTERED" | wc -l)
            echo "â• æ–°å¢æ–‡ä»¶: $ADDED_COUNT ä¸ª"
            echo "$ADDED_FILES_FILTERED" | head -10 | sed 's/^/    ğŸ“„ æ–°å¢: /'
            if [ "$ADDED_COUNT" -gt 10 ]; then
              echo "    ... è¿˜æœ‰ $(($ADDED_COUNT - 10)) ä¸ªæ–°å¢æ–‡ä»¶"
            fi
          else
            ADDED_COUNT=0
            echo "â• æ–°å¢æ–‡ä»¶: 0 ä¸ª"
          fi
          
          # ç»Ÿè®¡ä¿®æ”¹æ–‡ä»¶
          if [ -n "$MODIFIED_FILES_FILTERED" ] && [ "$MODIFIED_FILES_FILTERED" != "" ]; then
            MODIFIED_COUNT=$(echo "$MODIFIED_FILES_FILTERED" | wc -l)
            echo "âœï¸ ä¿®æ”¹æ–‡ä»¶: $MODIFIED_COUNT ä¸ª"
            echo "$MODIFIED_FILES_FILTERED" | head -10 | sed 's/^/    ğŸ“ ä¿®æ”¹: /'
            if [ "$MODIFIED_COUNT" -gt 10 ]; then
              echo "    ... è¿˜æœ‰ $(($MODIFIED_COUNT - 10)) ä¸ªä¿®æ”¹æ–‡ä»¶"
            fi
          else
            MODIFIED_COUNT=0
            echo "âœï¸ ä¿®æ”¹æ–‡ä»¶: 0 ä¸ª"
          fi
          
          # ç»Ÿè®¡åˆ é™¤æ–‡ä»¶
          if [ -n "$DELETED_FILES_FILTERED" ] && [ "$DELETED_FILES_FILTERED" != "" ]; then
            DELETED_COUNT=$(echo "$DELETED_FILES_FILTERED" | wc -l)
            echo "ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶: $DELETED_COUNT ä¸ª"
            echo "$DELETED_FILES_FILTERED" | head -10 | sed 's/^/    ğŸ—‚ï¸ åˆ é™¤: /'
            if [ "$DELETED_COUNT" -gt 10 ]; then
              echo "    ... è¿˜æœ‰ $(($DELETED_COUNT - 10)) ä¸ªåˆ é™¤æ–‡ä»¶"
            fi
          else
            DELETED_COUNT=0
            echo "ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶: 0 ä¸ª"
          fi
          
          # åˆå¹¶éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆæ–°å¢+ä¿®æ”¹ï¼‰
          echo ""
          echo "ğŸ“¤ å‡†å¤‡ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ï¼ˆæ–°å¢+ä¿®æ”¹ï¼‰..."
          if [ "$ADDED_COUNT" -gt 0 ] || [ "$MODIFIED_COUNT" -gt 0 ]; then
            UPLOAD_FILES=$(echo -e "$ADDED_FILES_FILTERED\n$MODIFIED_FILES_FILTERED" | grep -v "^$" | sort | uniq || true)
            UPLOAD_COUNT=$(echo "$UPLOAD_FILES" | wc -l)
            echo "ğŸ“Š æ€»å…±éœ€è¦ä¸Šä¼ : $UPLOAD_COUNT ä¸ªæ–‡ä»¶"
          else
            UPLOAD_FILES=""
            UPLOAD_COUNT=0
            echo "ğŸ“Š æ²¡æœ‰æ–‡ä»¶éœ€è¦ä¸Šä¼ "
          fi
          
          echo ""
          echo "ğŸ“‹ æœ€ç»ˆåŒæ­¥è®¡åˆ’ï¼š"
          echo "- ğŸ“¤ éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶: $UPLOAD_COUNT ä¸ªï¼ˆæ–°å¢: $ADDED_COUNT + ä¿®æ”¹: $MODIFIED_COUNTï¼‰"
          echo "- ğŸ—‘ï¸ éœ€è¦åˆ é™¤çš„æ–‡ä»¶: $DELETED_COUNT ä¸ª"
          
          # ä¿å­˜å˜æ›´ä¿¡æ¯åˆ°è¾“å‡ºå˜é‡
          {
            echo "upload_files<<EOF"
            echo "$UPLOAD_FILES"
            echo "EOF"
            echo "deleted_files<<EOF"
            echo "$DELETED_FILES_FILTERED"
            echo "EOF"
            echo "added_files<<EOF"
            echo "$ADDED_FILES_FILTERED"
            echo "EOF"
            echo "modified_files<<EOF"
            echo "$MODIFIED_FILES_FILTERED"
            echo "EOF"
            echo "upload_count=$UPLOAD_COUNT"
            echo "deleted_count=$DELETED_COUNT"
            echo "added_count=$ADDED_COUNT"
            echo "modified_count=$MODIFIED_COUNT"
          } >> $GITHUB_OUTPUT
        
      - name: å®‰è£… QShell å·¥å…·
        run: |
          echo "ğŸ“¦ æ­£åœ¨ä¸‹è½½å¹¶å®‰è£… QShell..."
          wget https://github.com/qiniu/qshell/releases/download/v2.13.0/qshell-v2.13.0-linux-amd64.tar.gz -O qshell.tar.gz
          if [ $? -ne 0 ]; then
            echo "âŒ ä¸‹è½½ QShell å¤±è´¥ï¼Œé€€å‡ºã€‚"
            exit 1
          fi
          
          echo "ğŸ“¦ æ­£åœ¨è§£å‹ QShell..."
          tar -zxvf qshell.tar.gz
          
          if [ -f "qshell-v2.13.0-linux-amd64" ]; then
            sudo mv qshell-v2.13.0-linux-amd64 /usr/local/bin/qshell
          elif [ -f "qshell" ]; then
            sudo mv qshell /usr/local/bin/qshell
          else
            echo "âŒ è§£å‹åæœªæ‰¾åˆ° qshell å¯æ‰§è¡Œæ–‡ä»¶"
            ls -la
            exit 1
          fi
          
          sudo chmod +x /usr/local/bin/qshell
          echo "âœ… QShell å®‰è£…å®Œæˆ"
          qshell -v || qshell version || echo "QShell å·²å®‰è£…"
          
      - name: é…ç½®ä¸ƒç‰›äº‘è´¦æˆ·
        env:
          QINIU_ACCESS_KEY: ${{ secrets.QINIU_ACCESS_KEY }}
          QINIU_SECRET_KEY: ${{ secrets.QINIU_SECRET_KEY }}
        run: |
          echo "ğŸ”‘ æ­£åœ¨é…ç½®ä¸ƒç‰›äº‘è´¦æˆ·..."
          if [ -z "$QINIU_ACCESS_KEY" ] || [ -z "$QINIU_SECRET_KEY" ]; then
            echo "âŒ ä¸ƒç‰›äº‘å¯†é’¥æœªè®¾ç½®"
            exit 1
          fi
          
          qshell account "$QINIU_ACCESS_KEY" "$QINIU_SECRET_KEY" "github-actions-æ™ºèƒ½åŒæ­¥"
          if [ $? -eq 0 ]; then
            echo "âœ… ä¸ƒç‰›äº‘è´¦æˆ·é…ç½®æˆåŠŸ"
          else
            echo "âŒ ä¸ƒç‰›äº‘è´¦æˆ·é…ç½®å¤±è´¥"
            exit 1
          fi
          
      - name: æµ‹è¯•ä¸ƒç‰›äº‘è¿æ¥
        env:
          QINIU_BUCKET_NAME: ${{ secrets.QINIU_BUCKET_NAME }}
        run: |
          echo "ğŸ” æµ‹è¯•ä¸ƒç‰›äº‘è¿æ¥..."
          if [ -z "$QINIU_BUCKET_NAME" ]; then
            echo "âŒ QINIU_BUCKET_NAME æœªè®¾ç½®"
            exit 1
          fi
          
          echo "å­˜å‚¨æ¡¶: $QINIU_BUCKET_NAME"
          qshell listbucket "$QINIU_BUCKET_NAME" "" 1 || echo "âš ï¸ è¿æ¥æµ‹è¯•å®Œæˆ"
          
      - name: æ™ºèƒ½å¢é‡åŒæ­¥æ–‡ä»¶
        id: smart-sync
        env:
          QINIU_BUCKET_NAME: ${{ secrets.QINIU_BUCKET_NAME }}
          QINIU_BUCKET_PREFIX: ${{ secrets.QINIU_BUCKET_PREFIX || '' }}
        run: |
          echo "ğŸš€ å¼€å§‹æ™ºèƒ½å¢é‡åŒæ­¥..."
          
          upload_files="${{ steps.changed-files.outputs.upload_files }}"
          deleted_files="${{ steps.changed-files.outputs.deleted_files }}"
          upload_count="${{ steps.changed-files.outputs.upload_count }}"
          deleted_count="${{ steps.changed-files.outputs.deleted_count }}"
          added_count="${{ steps.changed-files.outputs.added_count }}"
          modified_count="${{ steps.changed-files.outputs.modified_count }}"
          
          success_count=0
          failure_count=0
          delete_success=0
          delete_failure=0
          added_success=0
          modified_success=0
          
          echo "ğŸ“Š æœ¬æ¬¡åŒæ­¥ä»»åŠ¡ï¼š"
          echo "- ğŸ“¤ ä¸Šä¼ æ–‡ä»¶æ€»æ•°: $upload_count ä¸ªï¼ˆæ–°å¢: $added_count + ä¿®æ”¹: $modified_countï¼‰"
          echo "- ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶æ€»æ•°: $deleted_count ä¸ª"
          
          # æ­¥éª¤1ï¼šä¸Šä¼ å˜æ›´çš„æ–‡ä»¶ï¼ˆæ–°å¢+ä¿®æ”¹ï¼‰
          if [ "$upload_count" -gt 0 ]; then
            echo ""
            echo "ğŸ“¤ å¼€å§‹ä¸Šä¼  $upload_count ä¸ªæ–‡ä»¶..."
            echo "   - å…¶ä¸­æ–°å¢æ–‡ä»¶: $added_count ä¸ª"
            echo "   - å…¶ä¸­ä¿®æ”¹æ–‡ä»¶: $modified_count ä¸ª"
            
            # åˆ›å»ºä¸Šä¼ åˆ—è¡¨æ–‡ä»¶
            echo "$upload_files" > upload_list.txt
            
            # é€ä¸ªä¸Šä¼ æ–‡ä»¶
            current_file=1
            while IFS= read -r file; do
              if [ -n "$file" ] && [ -f "$file" ]; then
                echo "ğŸ“¤ [$current_file/$upload_count] æ­£åœ¨ä¸Šä¼ : $file"
                
                # åˆ¤æ–­æ–‡ä»¶ç±»å‹ï¼ˆæ–°å¢è¿˜æ˜¯ä¿®æ”¹ï¼‰
                if echo "${{ steps.changed-files.outputs.added_files }}" | grep -q "^$file$"; then
                  file_type="æ–°å¢"
                elif echo "${{ steps.changed-files.outputs.modified_files }}" | grep -q "^$file$"; then
                  file_type="ä¿®æ”¹"
                else
                  file_type="æœªçŸ¥"
                fi
                
                echo "   ğŸ·ï¸  æ–‡ä»¶ç±»å‹: $file_type"
                
                # æ„å»ºè¿œç¨‹è·¯å¾„
                if [ -n "$QINIU_BUCKET_PREFIX" ]; then
                  remote_path="${QINIU_BUCKET_PREFIX}${file}"
                else
                  remote_path="$file"
                fi
                
                echo "   ğŸ¯ è¿œç¨‹è·¯å¾„: $remote_path"
                
                # ä¸Šä¼ æ–‡ä»¶ï¼ˆä½¿ç”¨ --overwrite å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨çš„æ–‡ä»¶ï¼‰
                if qshell fput "$QINIU_BUCKET_NAME" "$remote_path" "$file" --overwrite; then
                  echo "   âœ… ä¸Šä¼ æˆåŠŸ: $file"
                  success_count=$((success_count + 1))
                  
                  # ç»Ÿè®¡æˆåŠŸç±»å‹
                  if [ "$file_type" = "æ–°å¢" ]; then
                    added_success=$((added_success + 1))
                  elif [ "$file_type" = "ä¿®æ”¹" ]; then
                    modified_success=$((modified_success + 1))
                  fi
                else
                  echo "   âŒ ä¸Šä¼ å¤±è´¥: $file"
                  failure_count=$((failure_count + 1))
                fi
                
                current_file=$((current_file + 1))
                echo ""
              fi
            done < upload_list.txt
            
            echo "ğŸ“Š ä¸Šä¼ é˜¶æ®µå®Œæˆï¼š"
            echo "- âœ… ä¸Šä¼ æˆåŠŸ: $success_count/$upload_count"
            echo "- âŒ ä¸Šä¼ å¤±è´¥: $failure_count"
            echo "- ğŸ“„ æ–°å¢æ–‡ä»¶æˆåŠŸ: $added_success/$added_count"
            echo "- ğŸ“ ä¿®æ”¹æ–‡ä»¶æˆåŠŸ: $modified_success/$modified_count"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶éœ€è¦ä¸Šä¼ "
          fi
          
          # æ­¥éª¤2ï¼šåˆ é™¤è¿œç¨‹å¤šä½™çš„æ–‡ä»¶
          if [ "$deleted_count" -gt 0 ]; then
            echo ""
            echo "ğŸ—‘ï¸ å¼€å§‹åˆ é™¤ $deleted_count ä¸ªè¿œç¨‹æ–‡ä»¶..."
            
            echo "$deleted_files" > delete_list.txt
            
            current_delete=1
            while IFS= read -r file; do
              if [ -n "$file" ]; then
                echo "ğŸ—‘ï¸ [$current_delete/$deleted_count] æ­£åœ¨åˆ é™¤: $file"
                
                # æ„å»ºè¿œç¨‹è·¯å¾„
                if [ -n "$QINIU_BUCKET_PREFIX" ]; then
                  remote_path="${QINIU_BUCKET_PREFIX}${file}"
                else
                  remote_path="$file"
                fi
                
                echo "   ğŸ¯ è¿œç¨‹è·¯å¾„: $remote_path"
                
                # åˆ é™¤æ–‡ä»¶
                if qshell delete "$QINIU_BUCKET_NAME" "$remote_path"; then
                  echo "   âœ… åˆ é™¤æˆåŠŸ: $file"
                  delete_success=$((delete_success + 1))
                else
                  echo "   âš ï¸ åˆ é™¤å¤±è´¥æˆ–æ–‡ä»¶ä¸å­˜åœ¨: $file"
                  delete_failure=$((delete_failure + 1))
                fi
                
                current_delete=$((current_delete + 1))
                echo ""
              fi
            done < delete_list.txt
            
            echo "ğŸ“Š åˆ é™¤é˜¶æ®µå®Œæˆï¼š"
            echo "- âœ… åˆ é™¤æˆåŠŸ: $delete_success/$deleted_count"
            echo "- âš ï¸ åˆ é™¤å¤±è´¥: $delete_failure"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶éœ€è¦åˆ é™¤"
          fi
          
          # è®¡ç®—æ€»ä½“ç»“æœ
          total_operations=$((upload_count + deleted_count))
          total_success=$((success_count + delete_success))
          
          echo ""
          echo "ğŸ¯ æ™ºèƒ½åŒæ­¥æœ€ç»ˆç»“æœç»Ÿè®¡ï¼š"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¤ ä¸Šä¼ ç»Ÿè®¡ï¼š"
          echo "   - ğŸ“„ æ–°å¢æ–‡ä»¶: $added_success/$added_count æˆåŠŸ"
          echo "   - ğŸ“ ä¿®æ”¹æ–‡ä»¶: $modified_success/$modified_count æˆåŠŸ"
          echo "   - ğŸ“Š ä¸Šä¼ æ€»è®¡: $success_count/$upload_count æˆåŠŸ"
          echo "   - âŒ ä¸Šä¼ å¤±è´¥: $failure_count ä¸ª"
          echo ""
          echo "ğŸ—‘ï¸ åˆ é™¤ç»Ÿè®¡ï¼š"
          echo "   - âœ… åˆ é™¤æˆåŠŸ: $delete_success/$deleted_count"
          echo "   - âŒ åˆ é™¤å¤±è´¥: $delete_failure ä¸ª"
          echo ""
          echo "ğŸ† æ€»ä½“ç»Ÿè®¡ï¼š"
          echo "   - ğŸ“‹ æ€»æ“ä½œæ•°: $total_operations"
          echo "   - âœ… æˆåŠŸæ“ä½œ: $total_success"
          echo "   - ğŸ“ˆ æˆåŠŸç‡: $(($total_success * 100 / ($total_operations > 0 ? $total_operations : 1)))%"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # ç¡®å®šåŒæ­¥çŠ¶æ€
          if [ "$total_operations" -eq 0 ]; then
            sync_status="no_changes"
            echo "â„¹ï¸ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€åŒæ­¥"
          elif [ "$failure_count" -eq 0 ] && [ "$delete_failure" -eq 0 ]; then
            sync_status="complete_success"
            echo "ğŸ‰ æ‰€æœ‰æ“ä½œéƒ½æˆåŠŸå®Œæˆï¼"
          elif [ "$success_count" -gt 0 ] || [ "$delete_success" -gt 0 ]; then
            sync_status="partial_success"
            echo "âš ï¸ éƒ¨åˆ†æ“ä½œæˆåŠŸï¼Œå­˜åœ¨å¤±è´¥é¡¹"
          else
            sync_status="failed"
            echo "âŒ åŒæ­¥æ“ä½œå¤±è´¥"
          fi
          
          # ä¿å­˜ç»“æœåˆ°è¾“å‡ºå˜é‡
          {
            echo "sync_status=$sync_status"
            echo "upload_success=$success_count"
            echo "upload_failure=$failure_count"
            echo "delete_success=$delete_success"
            echo "delete_failure=$delete_failure"
            echo "added_success=$added_success"
            echo "modified_success=$modified_success"
            echo "total_operations=$total_operations"
            echo "total_success=$total_success"
          } >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ‰ æ™ºèƒ½å¢é‡åŒæ­¥å®Œæˆï¼"

      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f qshell.tar.gz upload_list.txt delete_list.txt
          echo "âœ… æ¸…ç†å®Œæˆ"

      # æˆåŠŸé€šçŸ¥
      - name: å‘é€æˆåŠŸé€šçŸ¥é‚®ä»¶
        if: steps.smart-sync.outputs.sync_status == 'complete_success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… ä¸ƒç‰›äº‘æ™ºèƒ½åŒæ­¥æˆåŠŸ - ${{ github.repository }}"
          to: 344342823@qq.com
          from: ${{ secrets.EMAIL_USERNAME }}
          reply_to: ${{ secrets.EMAIL_USERNAME }}
          html_body: |
            <h2>ğŸ‰ æ™ºèƒ½å¢é‡åŒæ­¥æˆåŠŸ</h2>
            <p><strong>ä»“åº“ï¼š</strong> ${{ github.repository }}</p>
            <p><strong>åˆ†æ”¯ï¼š</strong> ${{ github.ref_name }}</p>
            <p><strong>æäº¤ï¼š</strong> ${{ github.sha }}</p>
            <p><strong>æäº¤è€…ï¼š</strong> ${{ github.actor }}</p>
            <p><strong>æäº¤ä¿¡æ¯ï¼š</strong> ${{ github.event.head_commit.message }}</p>
            <p><strong>åŒæ­¥æ—¶é—´ï¼š</strong> ${{ github.event.head_commit.timestamp }}</p>
            <p><strong>å­˜å‚¨æ¡¶ï¼š</strong> ${{ secrets.QINIU_BUCKET_NAME }}</p>
            
            <h3>ğŸ“Š æ™ºèƒ½åŒæ­¥ç»Ÿè®¡</h3>
            <p><strong>ğŸ“„ æ–°å¢æ–‡ä»¶ï¼š</strong> ${{ steps.smart-sync.outputs.added_success }} / ${{ steps.changed-files.outputs.added_count }} ä¸ªæˆåŠŸ</p>
            <p><strong>ğŸ“ ä¿®æ”¹æ–‡ä»¶ï¼š</strong> ${{ steps.smart-sync.outputs.modified_success }} / ${{ steps.changed-files.outputs.modified_count }} ä¸ªæˆåŠŸ</p>
            <p><strong>ğŸ“¤ ä¸Šä¼ æ–‡ä»¶ï¼š</strong> ${{ steps.smart-sync.outputs.upload_success }} / ${{ steps.changed-files.outputs.upload_count }} ä¸ªæˆåŠŸ</p>
            <p><strong>ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶ï¼š</strong> ${{ steps.smart-sync.outputs.delete_success }} / ${{ steps.changed-files.outputs.deleted_count }} ä¸ªæˆåŠŸ</p>
            <p><strong>ğŸ“‹ æ€»æ“ä½œæ•°ï¼š</strong> ${{ steps.smart-sync.outputs.total_operations }}</p>
            <p><strong>ğŸ“ˆ æˆåŠŸç‡ï¼š</strong> 100%</p>
            
            <h3>ğŸ“ æ–‡ä»¶å˜æ›´è¯¦æƒ…</h3>
            <h4>ğŸ“„ æ–°å¢çš„æ–‡ä»¶</h4>
            <pre>${{ steps.changed-files.outputs.added_files }}</pre>
            <h4>ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶</h4>
            <pre>${{ steps.changed-files.outputs.modified_files }}</pre>
            <h4>ğŸ—‘ï¸ åˆ é™¤çš„æ–‡ä»¶</h4>
            <pre>${{ steps.changed-files.outputs.deleted_files }}</pre>
            
            <hr>
            <p>âœ… æ™ºèƒ½å¢é‡åŒæ­¥å®Œæˆï¼Œæ‰€æœ‰æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶éƒ½å·²æˆåŠŸä¸Šä¼ ï¼</p>
            <p>ğŸ”— <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</a></p>

      # éƒ¨åˆ†æˆåŠŸé€šçŸ¥
      - name: å‘é€éƒ¨åˆ†æˆåŠŸé€šçŸ¥é‚®ä»¶
        if: steps.smart-sync.outputs.sync_status == 'partial_success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âš ï¸ ä¸ƒç‰›äº‘æ™ºèƒ½åŒæ­¥éƒ¨åˆ†æˆåŠŸ - ${{ github.repository }}"
          to: 344342823@qq.com
          from: ${{ secrets.EMAIL_USERNAME }}
          reply_to: ${{ secrets.EMAIL_USERNAME }}
          html_body: |
            <h2>âš ï¸ æ™ºèƒ½åŒæ­¥éƒ¨åˆ†æˆåŠŸ</h2>
            <p><strong>ä»“åº“ï¼š</strong> ${{ github.repository }}</p>
            <p><strong>åˆ†æ”¯ï¼š</strong> ${{ github.ref_name }}</p>
            <p><strong>æäº¤ï¼š</strong> ${{ github.sha }}</p>
            <p><strong>æäº¤è€…ï¼š</strong> ${{ github.actor }}</p>
            <p><strong>æäº¤ä¿¡æ¯ï¼š</strong> ${{ github.event.head_commit.message }}</p>
            <p><strong>åŒæ­¥æ—¶é—´ï¼š</strong> ${{ github.event.head_commit.timestamp }}</p>
            <p><strong>å­˜å‚¨æ¡¶ï¼š</strong> ${{ secrets.QINIU_BUCKET_NAME }}</p>
            
            <h3>ğŸ“Š æ™ºèƒ½åŒæ­¥ç»Ÿè®¡</h3>
            <p><strong>ğŸ“„ æ–°å¢æ–‡ä»¶ï¼š</strong> ${{ steps.smart-sync.outputs.added_success }} / ${{ steps.changed-files.outputs.added_count }} ä¸ªæˆåŠŸ</p>
            <p><strong>ğŸ“ ä¿®æ”¹æ–‡ä»¶ï¼š</strong> ${{ steps.smart-sync.outputs.modified_success }} / ${{ steps.changed-files.outputs.modified_count }} ä¸ªæˆåŠŸ</p>
            <p><strong>ğŸ“¤ ä¸Šä¼ æˆåŠŸï¼š</strong> ${{ steps.smart-sync.outputs.upload_success }} ä¸ª</p>
            <p><strong>âŒ ä¸Šä¼ å¤±è´¥ï¼š</strong> ${{ steps.smart-sync.outputs.upload_failure }} ä¸ª</p>
            <p><strong>âœ… åˆ é™¤æˆåŠŸï¼š</strong> ${{ steps.smart-sync.outputs.delete_success }} ä¸ª</p>
            <p><strong>âŒ åˆ é™¤å¤±è´¥ï¼š</strong> ${{ steps.smart-sync.outputs.delete_failure }} ä¸ª</p>
            <p><strong>ğŸ“‹ æ€»æ“ä½œæ•°ï¼š</strong> ${{ steps.smart-sync.outputs.total_operations }}</p>
            <p><strong>âœ… æˆåŠŸæ“ä½œï¼š</strong> ${{ steps.smart-sync.outputs.total_success }}</p>
            
            <h3>ğŸ“ æ–‡ä»¶å˜æ›´è¯¦æƒ…</h3>
            <h4>ğŸ“„ å°è¯•æ–°å¢çš„æ–‡ä»¶</h4>
            <pre>${{ steps.changed-files.outputs.added_files }}</pre>
            <h4>ğŸ“ å°è¯•ä¿®æ”¹çš„æ–‡ä»¶</h4>
            <pre>${{ steps.changed-files.outputs.modified_files }}</pre>
            <h4>ğŸ—‘ï¸ å°è¯•åˆ é™¤çš„æ–‡ä»¶</h4>
            <pre>${{ steps.changed-files.outputs.deleted_files }}</pre>
            
            <hr>
            <p>âš ï¸ éƒ¨åˆ†æ“ä½œæˆåŠŸï¼Œå»ºè®®æ£€æŸ¥å¤±è´¥åŸå› </p>
            <p>ğŸ”— <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</a></p>
            <p>ğŸ“‹ <strong>å»ºè®®æ“ä½œï¼š</strong></p>
            <ul>
              <li>æ£€æŸ¥å¤±è´¥æ–‡ä»¶çš„å…·ä½“é”™è¯¯åŸå› </li>
              <li>ç¡®è®¤ä¸ƒç‰›äº‘å­˜å‚¨æ¡¶æƒé™é…ç½®</li>
              <li>éªŒè¯ç½‘ç»œè¿æ¥ç¨³å®šæ€§</li>
              <li>æ‰‹åŠ¨é‡æ–°è§¦å‘å·¥ä½œæµé‡è¯•</li>
            </ul>

      # æ— å˜æ›´é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: å‘é€æ— å˜æ›´é€šçŸ¥é‚®ä»¶
        if: steps.smart-sync.outputs.sync_status == 'no_changes'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "â„¹ï¸ ä¸ƒç‰›äº‘æ™ºèƒ½åŒæ­¥ - æ— å˜æ›´ - ${{ github.repository }}"
          to: 344342823@qq.com
          from: ${{ secrets.EMAIL_USERNAME }}
          reply_to: ${{ secrets.EMAIL_USERNAME }}
          html_body: |
            <h2>â„¹ï¸ æ™ºèƒ½åŒæ­¥æ£€æŸ¥å®Œæˆ</h2>
            <p><strong>ä»“åº“ï¼š</strong> ${{ github.repository }}</p>
            <p><strong>åˆ†æ”¯ï¼š</strong> ${{ github.ref_name }}</p>
            <p><strong>æäº¤ï¼š</strong> ${{ github.sha }}</p>
            <p><strong>æäº¤è€…ï¼š</strong> ${{ github.actor }}</p>
            <p><strong>æäº¤ä¿¡æ¯ï¼š</strong> ${{ github.event.head_commit.message }}</p>
            <p><strong>æ£€æŸ¥æ—¶é—´ï¼š</strong> ${{ github.event.head_commit.timestamp }}</p>
            
            <h3>ğŸ“Š æ£€æŸ¥ç»“æœ</h3>
            <p><strong>ğŸ“„ æ–°å¢æ–‡ä»¶ï¼š</strong> 0 ä¸ª</p>
            <p><strong>ğŸ“ ä¿®æ”¹æ–‡ä»¶ï¼š</strong> 0 ä¸ª</p>
            <p><strong>ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶ï¼š</strong> 0 ä¸ª</p>
            <p><strong>çŠ¶æ€ï¼š</strong> æ— éœ€åŒæ­¥</p>
            
            <hr>
            <p>â„¹ï¸ æœ¬æ¬¡æäº¤æ²¡æœ‰éœ€è¦åŒæ­¥åˆ°ä¸ƒç‰›äº‘çš„æ–‡ä»¶å˜æ›´</p>
            <p>ğŸ”— <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</a></p>

      # å®Œå…¨å¤±è´¥é€šçŸ¥
      - name: å‘é€å¤±è´¥é€šçŸ¥é‚®ä»¶
        if: failure() || steps.smart-sync.outputs.sync_status == 'failed'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ ä¸ƒç‰›äº‘æ™ºèƒ½åŒæ­¥å¤±è´¥ - ${{ github.repository }}"
          to: 344342823@qq.com
          from: ${{ secrets.EMAIL_USERNAME }}
          reply_to: ${{ secrets.EMAIL_PASSWORD }}
          html_body: |
            <h2>âŒ æ™ºèƒ½åŒæ­¥å¤±è´¥</h2>
            <p><strong>ä»“åº“ï¼š</strong> ${{ github.repository }}</p>
            <p><strong>åˆ†æ”¯ï¼š</strong> ${{ github.ref_name }}</p>
            <p><strong>æäº¤ï¼š</strong> ${{ github.sha }}</p>
            <p><strong>æäº¤è€…ï¼š</strong> ${{ github.actor }}</p>
            <p><strong>æäº¤ä¿¡æ¯ï¼š</strong> ${{ github.event.head_commit.message }}</p>
            <p><strong>å¤±è´¥æ—¶é—´ï¼š</strong> ${{ github.event.head_commit.timestamp }}</p>
            
            <h3>ğŸ“Š å°è¯•åŒæ­¥çš„æ–‡ä»¶</h3>
            <p><strong>ğŸ“„ è®¡åˆ’æ–°å¢ï¼š</strong> ${{ steps.changed-files.outputs.added_count || 'æœªçŸ¥' }} ä¸ªæ–‡ä»¶</p>
            <p><strong>ğŸ“ è®¡åˆ’ä¿®æ”¹ï¼š</strong> ${{ steps.changed-files.outputs.modified_count || 'æœªçŸ¥' }} ä¸ªæ–‡ä»¶</p>
            <p><strong>ğŸ“¤ è®¡åˆ’ä¸Šä¼ ï¼š</strong> ${{ steps.changed-files.outputs.upload_count || 'æœªçŸ¥' }} ä¸ªæ–‡ä»¶</p>
            <p><strong>ğŸ—‘ï¸ è®¡åˆ’åˆ é™¤ï¼š</strong> ${{ steps.changed-files.outputs.deleted_count || 'æœªçŸ¥' }} ä¸ªæ–‡ä»¶</p>
            
            <hr>
            <p>âŒ æ™ºèƒ½åŒæ­¥è¿‡ç¨‹ä¸­å‘ç”Ÿå…³é”®é”™è¯¯</p>
            <p>ğŸ”— <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</a></p>
            <p>ğŸ“‹ <strong>æ’æŸ¥æ­¥éª¤ï¼š</strong></p>
            <ul>
              <li>æ£€æŸ¥ä¸ƒç‰›äº‘å¯†é’¥é…ç½®</li>
              <li>ç¡®è®¤å­˜å‚¨æ¡¶æƒé™</li>
              <li>éªŒè¯ç½‘ç»œè¿æ¥</li>
              <li>æ£€æŸ¥ QShell å·¥å…·å®‰è£…</li>
              <li>æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—</li>
            </ul>